---
params:
  pheno_name:
    label: Phenotype
    value: GLP1_G83_ins_secrete_gm
  chrID:
    label: Chromosome
    value: 1
  coefType:
    choices:
    - coef
    - blup
    input: select
    label: Coefficient calculation
    value: coef
  dataSetup:
    choices:
    - dataJax.R
    - dataMadison.R
    - dataJaxMadison.R
    input: select
    label: Data setup file
    value: dataJaxMadison.R
  docTitle:
    label: Document title
    value: Mediation Scan
  snpScan:
    input: numeric
    label: Width for SNP scan (0 = whole chromosome)
    value: 10
  offset:
    label: Offset width for fine mapping
    value: 2
  drivers:
    label: Dual or lone drivers
    choices:
    - dual
    - lone
    value: dual
  resultpath:
    input: text
    label: Path to put CSV results (none if '')
    value: '.'
  docAuthor:
    label: Author
    value: '[Brian S Yandell](brian.yandell@wisc.edu)'
  docOutput:
    choices:
    - html_document
    - pdf_document
    - word_document
    input: select
    label: Output format
    value: html_document
  datapath:
    input: text
    label: Path to derived data (required for Madison)
    value: ..
  showPeaks:
    label: Show highest peaks (0=no, n=number to show)
    value: 0
  useIntcov:
    choices:
    - no
    - yes
    label: Use interacting covariate (sex)?
    value: no
  extraSteps:
    label: Exra steps file (optional)
    value: ''
---

---
title: "`r params$docTitle`"
author: "`r params$docAuthor`"
date: "`r  format(Sys.time(), '%d %B %Y')`"
output:
  "`r params$docOutput`":
    toc: true
    toc_depth: 3
    code_folding: hide
---

```{r setup, include=FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(plotly)
```

This is built off script developed by Dan Gatti. In Rstudio, use `Knit with Parameters` from <kbd>Knit</kbd> pulldown to adjust parameter settings. See [README.md](README.md) for details.

```{r}
pheno_name <- params$pheno_name
chr_id <- as.character(params$chrID)
datapath <- params$datapath
resultpath <- params$resultpath
```

```{r}
data.frame(params_value = unlist(params))
```

### Data Setup

```{r}
source(params$dataSetup)
```

```{r}
addcovar <- qtl2pattern::covar_df_mx(covar)
```

```{r}
intcovar <- NULL
```

### Genome scan information

```{r}
genoprobs <- query_probs()$probs
map <- query_probs()$map
```

```{r}
(peaks <- readxl::read_excel("local/Jax/Ex vivo peak summary with QTL count[1].xlsx",
                            col_types = c(rep("text", 2), rep("numeric", 12), "text")) %>%
  dplyr::filter(lodcolumn == pheno_name,
                chr == chr_id))
```

```{r}
if(!nrow(peaks)) {
  cat("no peaks for", pheno_name, "\n")
  knitr::knit_exit()
}
```

```{r ins_peaks}
pos_Mbp <- peaks$pos[1]
```

### Mediation with allele probs.

```{r peak_mar,message=FALSE}
peak_mar <- qtl2::find_marker(map, chr_id, pos_Mbp)
ap <- qtl2::pull_genoprobpos(genoprobs, peak_mar)
```

```{r}
mrna <- query_mrna(chr_id)
mrna.annot <- mrna$annot
```

Find peaks for local mRNA that are close to SNP peak.

```{r}
epeaks <- 
  dplyr::filter(
    mrna$peaks,
    qtl_chr == chr_id,
    abs(qtl_pos - peaks$pos) <= params$snpScan)
med_signif <- which(names(mrna$expr) %in% epeaks$gene_id)
```

```{r}
if(params$drivers == "dual") {
  mrna.annot$driver <- qtl2::find_marker(map, chr_id, mrna.annot$pos)
  driver_med <- genoprobs[[chr_id]][,,unique(mrna.annot$driver), drop = FALSE]
} else {
  driver_med <- NULL
}
```

```{r med_test,fig.width=9,fig.height=6}
med_test <- intermediate::mediation_test(
  target   = pheno_data[,pheno_name,drop=FALSE],
  mediator = mrna$expr[, med_signif, drop = FALSE],
  annotation = mrna.annot,
  covar_tar = covar,
  covar_med = covar,
  kinship = kinship[[chr_id]],
  intcovar = intcovar,
  driver = ap,
  driver_med = driver_med)
ggplotly(autoplot(med_test))
```

```{r}
(sum_med <- 
   dplyr::arrange(
     summary(med_test),
     pvalue))
```

```{r}
if(resultpath != "")
  write.csv(sum_med, file = file.path(params$resultpath,
                                      paste0(pheno_name, "_", chr_id, "_mediation.csv")))
```

```{r}
if(params$drivers == "dual") {
  driver <- driver_med[,, dplyr::filter(mrna.annot, id == sum_med$id[1])$driver]
} else {
  driver <- ap
}
```

```{r med_triad,fig.width=9,fig.height=6}
med_triad <- intermediate::mediation_triad(
  target   = pheno_data[,pheno_name,drop=FALSE],
  mediator = mrna$expr[, sum_med$id[1], drop = FALSE],
  driver = driver,
  covar_tar = covar,
  kinship = kinship[[chr_id]],
  sdp = sum(2 ^ (4:7)))
autoplot(med_triad, tname = pheno_name, mname = sum_med$symbol[1], dname = peak_mar)
```

#### Driver effects by Mediator, Target, Adjusted model.

```{r}
meds <- 
  dplyr::rename(
    dplyr::mutate(
      dplyr::select(
        sum_med,
        symbol, chr, pos, mediation, pvalue, dplyr::everything()),
      mediation = mediation / log(10),
      chr = as.character(chr),
      LRmed = LRmed / log(10)),
    lod_adj = "mediation",
    mediator = "symbol",
    lod_med = "LRmed")
```

```{r}
peaks_mod <- 
  dplyr::rename(
    dplyr::arrange(
      dplyr::mutate(
        peaks,
        lodcolumn = paste(lodcolumn, chr, sep = "_")),
      dplyr::desc(lod)),
    target = "lodcolumn",
    pos_tar = "pos",
    lod_tar = "lod",
    group = "QTL")
m <- match(LETTERS[1:8], names(peaks_mod))
names(peaks_mod)[m] <- paste0(LETTERS[1:8], "_p")
```

```{r}
out <- 
  dplyr::left_join(meds, peaks_mod, by = "chr") %>%
  dplyr::filter(pvalue <= 0.05)
```

```{r}
plotly::ggplotly(
  ggplot2::ggplot(out) +
    ggplot2::aes(lod_tar - lod_adj, -log10(pvalue), col = biotype,
                 symbol = mediator, pvalue = pvalue) +
    ggplot2::geom_point())
```

```{r}
tmp <- rep(seq_len(ceiling(nrow(out) / 6)), each = 6, length = nrow(out))
outp <- split(out, tmp)
driver_effects <- purrr::map(outp, intermediate::driver_effect)
```

```{r fig.width = 12, fig.heigth = 9}
invisible(sapply(driver_effects, function(x) print(intermediate::ggplot_driver_effect(x))))
```

### Association mapping

Map all of Chr `r chr_id` unless `snpScan` (`r params$snpScan`) is positive.

```{r}
snpScan <- as.numeric(params$snpScan)
if(is.na(snpScan) || snpScan <= 0) {
  start <- end <- NULL
} else {
  start <- pos_Mbp - snpScan
  end <- pos_Mbp + snpScan
}
```

```{r}
pairprobs <- query_probs(chr = chr_id, start = start, stop = end, allele = FALSE)
pairmap <- pairprobs$map
pairprobs <- pairprobs$probs
```

```{r ins_assoc_chr,fig.width=12}
if(is.null(start) & is.null(end)) {
  cat(paste("scan1snps of chromosome", chr_id, "\n"), file = stderr())
} else {
  cat(paste("scan1snps of chromosome", chr_id, "from", start, "to", end, "\n"), file = stderr())
}
  
assoc_ins = qtl2::scan1snps(genoprobs = pairprobs[,chr_id], map = pairmap, 
                      pheno = pheno_data[,pheno_name,drop=F], kinship = kinship[[chr_id]],
                      addcovar = addcovar, intcovar = intcovar, chr = chr_id, start = start,
                      end = end, query_func = query_variant, cores = 4,
                      keep_all_snps = FALSE)
autoplot(assoc_ins$lod, assoc_ins$snpinfo, show_all_snps = FALSE)
```

```{r ins_assoc_rescan,fig.width=12}
(ts <- qtl2::top_snps(assoc_ins$lod, assoc_ins$snpinfo) %>%
  arrange(desc(lod))) %>%
  head(10)
```

```{r}
if(resultpath != "")
  write.csv(ts, file = file.path(params$resultpath,
                                 paste0(pheno_name, "_", chr_id, "_topsnps.csv")))
```

View patterns in top SNPs.

```{r assoc_ins_pattern,fig.width=9,fig.height=6}
autoplot(assoc_ins$lod, assoc_ins$snpinfo, patterns = "all", drop_hilit = 5, main = pheno_name)
```

### Top missense, splice or stop SNPs

```{r ins_top_snps_left}
left_join(ts %>% dplyr::rename(id = "ensembl_gene"),
          mrna.annot %>% select(id, symbol),
          by = "id") %>%
  select(snp_id, lod, pos, id, symbol, consequence) %>%
  head(10)
```

```{r}
if(resultpath != "")
  write.csv(left_join(ts %>% dplyr::rename(id = "ensembl_gene"),
          mrna.annot %>% select(id, symbol),
          by = "id"), 
          file = file.path(params$resultpath, 
                           paste0(pheno_name, "_", chr_id, "_topsnps_peak.csv")))
```

```{r}
ts %>% dplyr::filter(grepl("splice|missense|stop", consequence))
```

### Mediation with SNP probs

```{r peak_snp,message=FALSE}
sp_peak <- qtl2::genoprob_to_snpprob(pairprobs, assoc_ins$snpinfo)
peak_snp <- 
  qtl2::find_index_snp(
    assoc_ins$snpinfo,
    qtl2::find_marker(
      assoc_ins$snpinfo,
      ts$chr[1], ts$pos[1]))
sp <- sp_peak[[chr_id]][,, peak_snp]
```

```{r med2_scan,fig.width=9,fig.height=6}
med2_scan <- intermediate::mediation_scan(target  = pheno_data[,pheno_name,drop=FALSE],
                       mediator = mrna$expr[, med_signif, drop = FALSE],
                       annotation = mrna.annot,
                       covar    = addcovar,
                       driver = sp,
                       kinship = kinship[[chr_id]],
                       intcovar = intcovar,
                       method = "double-lod-diff")
ggplotly(autoplot(med2_scan) +
           ggtitle(pheno_name))
```

Find best SNP for each mediator.

```{r}
assoc_med = qtl2::scan1snps(genoprobs = pairprobs[,chr_id], map = pairmap, 
                      pheno = mrna$expr[, med_signif, drop = FALSE],
                      kinship = kinship[[chr_id]],
                      addcovar = addcovar, intcovar = intcovar, chr = chr_id, start = start,
                      end = end, query_func = query_variant, cores = 4,
                      keep_all_snps = FALSE)
```

```{r}
(ts_med <- qtl2pattern::top_snps_all(assoc_med$lod, assoc_med$snpinfo) %>%
  arrange(desc(lod))) %>%
  head(10)
```

```{r}
(ts_med <- ts_med %>%
   group_by(pheno, chr) %>%
   summarize(
     lod = max(lod),
     pos = pos[which.max(lod)]) %>%
   ungroup %>%
   arrange(desc(lod)))
```

Set up drivers for mediators.

```{r}
if(params$drivers == "dual") {
  med_snp <- 
    qtl2::find_index_snp(
      assoc_med$snpinfo,
      qtl2::find_marker(
        assoc_med$snpinfo,
        ts_med$chr, ts_med$pos))
  mrna.annot$driver[med_signif] <- med_snp
  driver_med_snp <- sp_peak[[chr_id]][,, unique(med_snp), drop = FALSE]
} else {
  driver_med_snp <- sp
}
```

```{r med2_test,fig.width=9,fig.height=6}
med2_test <- intermediate::mediation_test(
  target   = pheno_data[,pheno_name,drop=FALSE],
  mediator = mrna$expr[, med_signif, drop = FALSE],
  annotation = mrna.annot,
  covar_tar = covar,
  covar_med = covar,
  kinship = kinship[[chr_id]],
  intcovar = intcovar,
  driver = sp,
  driver_med = driver_med_snp)
ggplotly(autoplot(med2_test))
```

```{r}
(sum_med2 <- summary(med2_test))
```

```{r}
if(resultpath != "")
  write.csv(sum_med2, file = file.path(params$resultpath,
                                       paste0(pheno_name, "_", chr_id, "_mediation_snp.csv")))
```

```{r med2_triad,fig.width=9,fig.height=6}
med2_triad <- intermediate::mediation_triad(
  target   = pheno_data[,pheno_name,drop=FALSE],
  mediator = mrna$expr[, sum_med$id[1], drop = FALSE],
  driver = sp,
  covar_tar = covar,
  kinship = kinship[[chr_id]],
  sdp = ts$sdp,
  label_fn = NULL,
  group_fn = NULL)
autoplot(med2_triad, tname = pheno_name, mname = sum_med$symbol[1], dname = peak_snp)
```

```{r}
if(params$extraSteps != "")
  source(params$extraSteps)
```

Driver effects by Mediator, Target, Adjusted model.

```{r}
meds_snp <- 
  dplyr::rename(
    dplyr::mutate(
      dplyr::select(
        sum_med2,
        symbol, chr, pos, mediation, pvalue, dplyr::everything()),
      mediation = mediation / log(10),
      chr = as.character(chr),
      LRmed = LRmed / log(10)),
    lod_adj = "mediation",
    mediator = "symbol",
    lod_med = "LRmed",
    A = "AA",
    H = "AB",
    B = "BB",
    A_m = "AA_m",
    H_m = "AB_m",
    B_m = "BB_m")
```

```{r}
peaks_snp <- intermediate::fitQtl2(sp, 
                                   pheno_data[, pheno_name, drop = FALSE],
                                   kinship[[chr_id]],
                                   covar)
peaks_snp <- data.frame(target = paste(pheno_name, chr_id, sep = "_"),
                        chr = chr_id,
                        pos_tar = ts$pos[1],
                        lod_tar = peaks_snp$LR / log(10),
                        group = 1,
                        as.data.frame(t(peaks_snp$coef[1:3])),
                        stringsAsFactors = FALSE)
peaks_snp <- 
  dplyr::rename(
    peaks_snp,
    A_p = "AA",
    H_p = "AB",
    B_p = "BB")
```

```{r}
out_snp <- 
  dplyr::left_join(meds_snp, peaks_snp, by = "chr") %>%
  dplyr::filter(pvalue <= 0.05)
```

```{r}
plotly::ggplotly(
  ggplot2::ggplot(out_snp) +
    ggplot2::aes(lod_tar - lod_adj, -log10(pvalue), col = biotype, symbol = mediator) +
    ggplot2::geom_point())
```

```{r}
tmp <- rep(seq_len(ceiling(nrow(out_snp) / 6)), each = 6, length = nrow(out_snp))
outp <- split(out_snp, tmp)
driver_effects <- purrr::map(outp, intermediate::driver_effect, c("A","H","B"))
```

```{r fig.width = 12, fig.heigth = 9}
invisible(sapply(driver_effects, function(x) print(intermediate::ggplot_driver_effect(x))))
```

