---
title: "Mediation Summary"
author: "Brian S. Yandell"
date: "4/18/2018"
output: html_document
params:
  suffix:
    value: mediation_snp
    label: File suffix
  batch:
    value: batch2
    label: Batch directory
  cutoff:
    value: 0.05
    label: P-value cutoff
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The differences of this analysis and summary from the previous are:

- use separate causal drivers for mediators and target
    + earlier used only target for driver
    + mediators selected based on their peak, not on LOD at target driver
- using 3-level SNP (from 36 allele pair probabilities) for SNP analysis
- include Mediator-Target-Adjusted allele plot to compare alleles
- use 0.05 cutoff for summary (previous used 0.1)

```{r}
filenames <- list.files(params$batch, paste0("_", params$suffix, ".csv"))
names(filenames) <- stringr::str_replace(filenames, paste0("_", params$suffix, ".csv"), "")
filenames <- as.list(filenames)
```

```{r}
meds <- 
  dplyr::rename(
    dplyr::mutate(
      dplyr::select(
        dplyr::bind_rows(
          purrr::map(
            filenames,
            function(x) 
              dplyr::filter(
                read.csv(
                  file.path(params$batch, x),
                  stringsAsFactors = FALSE),
                triad == "causal",
                pvalue <= params$cutoff)),
          .id = "target"),
        target, symbol, chr, pos, mediation, pvalue, dplyr::everything()),
      mediation = mediation / log(10),
      chr = as.character(chr),
      LRmed = LRmed / log(10)),
    QTLs = "info",
    lod_adj = "mediation",
    mediator = "symbol",
    lod_med = "LRmed")
if(params$suffix != "mediation") {
  meds <- dplyr::rename(
    meds,
    A = "AA",
    H = "AB",
    B = "BB",
    A_m = "AA_m",
    H_m = "AB_m",
    B_m = "BB_m")
}
```

Need to relate this to the peaks file.

```{r}
tmpfn <- function(group) {
  wh <- which(!is.na(group))
  ct <- diff(c(wh, length(group) + 1))
  rep(group[wh], ct)
}
```

```{r}
peaks <- 
  dplyr::rename(
    dplyr::arrange(
      dplyr::mutate(
        readxl::read_excel(
          "local/Jax/Ex vivo peak summary with QTL count[1].xlsx",
          col_types = c(rep("text", 2), rep("numeric", 12), "numeric")),
        lodcolumn = paste(lodcolumn, chr, sep = "_"),
        QTL = tmpfn(QTL)),
      dplyr::desc(lod)),
    target = "lodcolumn",
    pos_tar = "pos",
    lod_tar = "lod",
    group = "QTL")
m <- match(LETTERS[1:8], names(peaks))
names(peaks)[m] <- paste0(LETTERS[1:8], "_p")
```

```{r}
out <- 
  dplyr::left_join(meds, peaks, by = c("target", "chr"))
```

```{r}
write.csv(out, file = paste0(params$suffix, "Summary.csv"))
```


### Plots

```{r}
tmpfn <- function(chr, group) {
  factor(unlist(sapply(split(group, chr), function(x) 1 + x - min(x))))
}
```

```{r}
out <- 
  dplyr::mutate(
    dplyr::arrange(
      out,
      group),
    chr = factor(chr, unique(chr)),
    chrGroup = tmpfn(chr, group))
```

```{r}
ggplot2::ggplot(out) +
  ggplot2::aes(lod_tar - lod_med, -log10(pvalue),
               col = chrGroup) +
  ggplot2::geom_point() +
  ggplot2::facet_wrap(~ chr)
```

```{r}
ggplot2::ggplot(out) +
  ggplot2::aes(pos_tar, pos, col = chrGroup) +
  ggplot2::geom_abline(slope=1, intercept=0, col="grey") +
  ggplot2::geom_point() +
  ggplot2::facet_wrap(~ chr)
```

```{r fig.width=9,fig.heigth=6}
plotly::ggplotly(ggplot2::ggplot(out) +
  ggplot2::aes(pos_tar, lod_tar - lod_med, col = chrGroup, symbol = mediator) +
  ggplot2::geom_point() +
  ggplot2::facet_wrap(~ chr))
```

### Plot of driver effects

Driver effects by Mediator, Target, Adjusted model.

```{r}
if(params$suffix == "mediation") {
  driver_levels <- LETTERS[1:8]
} else {
  driver_levels <- c("A","H","B")
}
```

```{r}
outp <- split(out, interaction(out$target, out$group, drop = TRUE))
driver_effects <- purrr::map(outp, intermediate::driver_effect, driver_levels)
```

```{r fig.width = 12, fig.heigth = 9}
invisible(sapply(driver_effects, function(x) print(intermediate::ggplot_driver_effect(x))))
```
